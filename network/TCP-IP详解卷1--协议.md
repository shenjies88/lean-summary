## 关键命令

- ping
- netstat
- traceroute

## 概述

路由器

- 转发分组
- 在下三层链接不同协议的网络

## 链路层

封装帧

- 以太网帧
- 802标准定义的帧
- SLIP:串行线路IP
  - 简单封装，头尾加上`END`
  - 无法交互双方IP，只有双方都知道的情况下才能通信
  - 没有类型字段只能同时运行一种协议
  - 没有校验
- PPP协议
  - 以`0xe7`开头和结尾
  - 有类型字段
  - 解决了`SLIP`的缺陷
- 回环接口
  - 走完整的网络流程
- MTC(最大传输单元)
  - 当在多个网络中通信时，取决于最小`MTC`

## 网际协议

IP协议

- IP首部字节采用`big endian`，即低位在左，高位在右，反之就是`little endian`

路由选择

- 对上层来说，是直线传输
- 对于下层实际是不断的路由器跳转
- 对于网络层来说是IP地址
- 对于链路层来说是以太网地址，由ARP协议解析`MAC地址`得来

ifconfig

- LINK0标志
  - 允许压缩`slip`的数据的配置选项
- LINK1标志
  - 如果从跟另一端收到压缩报文，就允许采用`CSLIP`和`LINK2`
- LINK2标志
  - 所有外出的`ICMP`报文都被丢弃
- SIMPLEX标志
  - 有该标志的接口不能收到本机传送的数据，如果接口发送一帧数据到广播地址，那么就会为本机拷贝一份数据到回环地址

netstat

- 查看系统上的接口信息

## ARP地址解析协议

工作原理及过程

- 在网络层是IP传输，实际在数据链路层是以以太网地址不断变动的传输
- 需要请求目的地址时，先向同网络的广播目的地址获取以太网地址
- 不在同一网络则转发到其他网络

## RARP逆地址解析协议

用途

- 无盘系统在引导时用来获取IP地址

例子

- 从网络上引导主机地址
- 首先广播主机的`mac地址`
- 应答主机发送`IP地址`给广播主机
- 广播主机收到`IP地址`后发送一个TFTP请求给一个文件引导镜像

## ICMP

不会产生ICMP差错报文的情况

- `ICMP`差错报文
- 目的地址是广播地址或多播地址的`IP数据报`
- 作为链路层广播的数据包
- 不是`IP分片`的第一片
- 源地不是单个主机的数据报，源地址不能为零地址、环回地址、广播地址或多播地址

ICMP的请求应答时间戳

- orig 发起时间戳
- revc 接受时间戳
- xmit 发送时间戳
- rtt 往返时间
  - RTT = A发请求->B接受.B传送应答->
- difference 接受时间减去发起时间，即传输过程的一半
- RTT/2 - difference，正数则请求主机时间戳比应答主机快，否则反之

ICMP差错不可达

- 差错不可达原因是目的端口号
- 当不可达时，不会把信息传输到运输层

## Ping程序

- IP路由选项
  - 记录途经的IP地址
- 错误不会经过传输层

## Traceroute程序

- IP源站选路选项
  - 宽松模式和严格模式
  - 选定程序运行时途经的路由器站点

## IP选路

- netstat -rn
  - 查看路由表
- 路由原理
  - 先选同网络主机
  - 查看是否有符合目的地址的网络
  - 默认地址
- ICMP重定向
  - 让有很少默认选路的主机，建立完善的路由表

## 动态路由选路协议

RIP选路信息协议

- 包含在UDP报文中
- 通过广播或者点对点链接，告诉通知周围路由器更新路由表
- 有一个`度量`值表示主机与该网络的距离，最大是15，适用于内部自治系统

## UDP用户数据报协议

UDP首部

UDP检验和

- 包括首部和数据
- IP检验和不包括数据

数据分片

- 运输层头部只出现在第一片
- 需要分片但又设置了不分片时，会发送ICMP不可达报文

用traceroute程序来确定mtu

- 不断的用最小值来尝试

用UDP来确定mtu

- 返回新的ICMP格式，会返回下一跳地址mtu，以此来决定mtu

源站抑制差错

- 即发送方的速率大于接收方的速率，会导致缓存溢出，而UDP不处理该种差错

## 广播和多播

广播和多播仅用于UDP

- 多播只关心自己所在的多播组，是广播的一种优化

## IGMP组管理协议

工作过程

- 多播组路由器会定时查询加入多播组的主机
- 主机内有至少1个进程在多播组内，则给予回应
- 多播组路由器记录组内有进程在组内的主机
- 会动态更新主机表